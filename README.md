# Joan

Local code review gate for AI agents. Agents push work to a local [Forgejo](https://forgejo.org) instance, a human reviews it, and only approved work gets pushed to the real upstream (GitHub, GitLab, etc.).

## How it works

```
agent commits → joan pr create → human reviews on Forgejo → joan pr push → origin
```

Joan enforces approval gates: `joan pr push` refuses to push if the PR is not approved or has unresolved comments.

## Prerequisites

- Python 3.13+
- [uv](https://docs.astral.sh/uv/)
- Docker (for the local Forgejo instance)
- A git repository

## Installation

### Install Joan

Add Joan to your project with `uv`:

```bash
uv add git+https://github.com/sam-phinizy/joan.git
```

Or run it directly without installing (no project dependency needed):

```bash
uvx --from git+https://github.com/sam-phinizy/joan.git joan --help
```

### Install the Claude Code plugin

Joan ships with a Claude Code plugin that teaches Claude the full review workflow — when to create PRs, how to check feedback, and how to push only approved work upstream.

Run this once in each repo where you want Claude to use Joan:

```bash
uv run joan skills install --agent claude
```

This copies the plugin to `.claude/plugins/joan/`. Claude Code loads it automatically on the next session. Claude will then follow the Joan review cycle without being prompted.

### Start Forgejo

Joan routes reviews through a local [Forgejo](https://forgejo.org) instance. Start it with Docker:

```bash
cd /path/to/joan/forge/
docker compose up -d
# Forgejo is now running at http://localhost:3000
```

On first run, open `http://localhost:3000` in your browser and create an admin account.

## Setup (per repo)

**1. Initialize Joan**

Run this once in the repo you want to gate:

```bash
uv run joan init
```

You will be prompted for:
- Forgejo URL (default: `http://localhost:3000`)
- Forgejo username and password
- Which Forgejo repo to use (defaults to current directory name)

This creates an API token on Forgejo and writes `.joan/config.toml`. Add `.joan/` to your `.gitignore` — the config contains an API token and must never be committed.

**2. Add the review remote**

```bash
uv run joan remote add
```

Creates a private repo on Forgejo and adds `joan-review` as a git remote pointing to it.

## Daily workflow

```bash
# Create a review branch and open a PR
uv run joan branch create
uv run joan pr create --title "Add feature X"

# Check review status
uv run joan pr sync

# See unresolved comments
uv run joan pr comments

# Resolve a comment after addressing it
uv run joan pr comment resolve <id>

# Push to upstream once approved
uv run joan pr push
```

## Config

`.joan/config.toml` (auto-generated by `joan init`):

```toml
[forgejo]
url = "http://localhost:3000"
token = "..."        # API token — never commit this
owner = "yourname"
repo = "yourrepo"

[remotes]
review = "joan-review"   # default
upstream = "origin"      # default
```

## Command reference

| Command | Description |
|---------|-------------|
| `joan init` | One-time setup: create token, write config |
| `joan remote add` | Create Forgejo repo, add `joan-review` remote |
| `joan branch create [name]` | Create and push a review branch |
| `joan pr create` | Open a PR on Forgejo |
| `joan pr sync` | JSON: approval status + unresolved comment count |
| `joan pr comments` | JSON: list unresolved review comments |
| `joan pr comment resolve <id>` | Mark a comment resolved |
| `joan pr push` | Push approved branch to upstream |
| `joan worktree create [name]` | Create an isolated git worktree |
| `joan worktree remove <name>` | Remove a tracked worktree |
| `joan skills install --agent claude` | Install the Claude Code plugin |
